# Requirements Document

## Введение

Данный документ описывает требования к расширению функциональности Yii2 блог-платформы. Включает систему авторизации с хранением в БД, профили пользователей, закладки, оптимизацию изображений, комментарии с модерацией, хлебные крошки, поиск с автодополнением и управление SEO.

## Требования

### Требование 1: Авторизация и регистрация

**User Story:** Как посетитель, я хочу зарегистрироваться и войти в систему, чтобы получить доступ к персонализированным функциям.

#### Критерии приёмки

1. WHEN пользователь переходит на `/login` THEN система SHALL отобразить форму входа с полями username/email и password
2. WHEN пользователь вводит корректные данные и нажимает "Войти" THEN система SHALL аутентифицировать пользователя и перенаправить на предыдущую страницу
3. WHEN пользователь вводит некорректные данные THEN система SHALL отобразить сообщение об ошибке без раскрытия причины (безопасность)
4. WHEN пользователь отмечает "Запомнить меня" THEN система SHALL сохранить сессию на 30 дней
5. WHEN пользователь переходит на `/register` THEN система SHALL отобразить форму регистрации с полями: username, email, password, password_confirm
6. WHEN пользователь отправляет форму регистрации с валидными данными THEN система SHALL создать аккаунт с хешированным паролем (bcrypt) и авторизовать пользователя
7. WHEN username или email уже существует THEN система SHALL отобразить соответствующую ошибку валидации
8. WHEN авторизованный пользователь переходит на `/logout` (POST) THEN система SHALL завершить сессию и перенаправить на главную
9. IF пользователь уже авторизован THEN система SHALL перенаправить с `/login` и `/register` на главную страницу

### Требование 2: Профили пользователей

**User Story:** Как пользователь, я хочу иметь публичный профиль и возможность его редактировать, чтобы представить себя другим пользователям.

#### Критерии приёмки

1. WHEN посетитель переходит на `/profile/{username}` THEN система SHALL отобразить публичный профиль с аватаром, bio, датой регистрации и активностью
2. WHEN владелец профиля переходит на `/profile/{username}/edit` THEN система SHALL отобразить форму редактирования с полями: avatar, bio, display_name
3. WHEN пользователь загружает аватар THEN система SHALL валидировать формат (jpg, png, gif, webp), размер (макс 2MB) и сохранить с оптимизацией
4. WHEN не-владелец пытается редактировать чужой профиль THEN система SHALL вернуть 403 Forbidden
5. WHEN пользователь переходит на `/profile/{username}/password` THEN система SHALL отобразить форму смены пароля с полями: current_password, new_password, confirm_password
6. WHEN пользователь отправляет форму смены пароля с корректным текущим паролем THEN система SHALL обновить пароль с хешированием
7. IF профиль не найден THEN система SHALL вернуть 404 Not Found

### Требование 3: Закладки (Избранное)

**User Story:** Как авторизованный пользователь, я хочу добавлять публикации в избранное, чтобы быстро находить интересный контент.

#### Критерии приёмки

1. WHEN авторизованный пользователь нажимает кнопку "В избранное" на публикации THEN система SHALL добавить публикацию в закладки через AJAX без перезагрузки страницы
2. WHEN пользователь нажимает кнопку на уже добавленной публикации THEN система SHALL удалить из закладок (toggle)
3. WHEN пользователь переходит на `/profile/{username}/favorites` THEN система SHALL отобразить список избранных публикаций с пагинацией
4. IF пользователь не авторизован THEN кнопка закладки SHALL перенаправить на страницу входа
5. WHEN публикация удаляется THEN система SHALL автоматически удалить связанные закладки

### Требование 4: ImageOptimizer

**User Story:** Как администратор, я хочу автоматическую оптимизацию загружаемых изображений, чтобы улучшить производительность сайта.

#### Критерии приёмки

1. WHEN изображение загружается THEN система SHALL конвертировать его в формат WebP с сохранением качества 85%
2. WHEN изображение загружается THEN система SHALL создать thumbnail версии: small (150x150), medium (400x300), large (800x600)
3. WHEN оригинальное изображение больше 1920px по ширине THEN система SHALL уменьшить до 1920px с сохранением пропорций
4. IF GD или Imagick недоступны THEN система SHALL сохранить оригинал и записать warning в лог
5. WHEN изображение удаляется THEN система SHALL удалить все связанные thumbnails

### Требование 5: Комментарии

**User Story:** Как посетитель, я хочу оставлять отзывы к публикациям с рейтингом, чтобы делиться мнением.

#### Критерии приёмки

1. WHEN пользователь просматривает публикацию THEN система SHALL отобразить форму комментария с полями: name (для гостей), email (для гостей), content, rating (1-5 звёзд)
2. WHEN авторизованный пользователь отправляет комментарий THEN система SHALL автоматически заполнить name и email из профиля
3. WHEN форма содержит заполненное honeypot поле THEN система SHALL отклонить комментарий как спам без уведомления
4. WHEN комментарий отправлен THEN система SHALL сохранить его со статусом "на модерации" (pending)
5. WHEN администратор одобряет комментарий THEN система SHALL изменить статус на "опубликован" и отобразить на странице
6. WHEN администратор отклоняет комментарий THEN система SHALL изменить статус на "отклонён" или удалить
7. IF комментарий содержит запрещённые слова THEN система SHALL автоматически пометить как спам

### Требование 6: Хлебные крошки

**User Story:** Как посетитель, я хочу видеть навигационные хлебные крошки, чтобы понимать своё местоположение на сайте.

#### Критерии приёмки

1. WHEN пользователь находится на любой странице кроме главной THEN система SHALL отобразить хлебные крошки
2. WHEN пользователь на странице публикации THEN хлебные крошки SHALL показывать: Главная > Категория > Название публикации
3. WHEN пользователь на странице категории THEN хлебные крошки SHALL показывать: Главная > Родительская категория (если есть) > Текущая категория
4. WHEN пользователь на странице профиля THEN хлебные крошки SHALL показывать: Главная > Профили > Username
5. WHEN элемент хлебных крошек кликабелен THEN система SHALL перенаправить на соответствующую страницу

### Требование 7: Поиск с автодополнением

**User Story:** Как посетитель, я хочу быстро находить контент через поиск с подсказками, чтобы экономить время.

#### Критерии приёмки

1. WHEN пользователь вводит текст в поле поиска в header THEN система SHALL отправить AJAX запрос на `/api/search/autocomplete` после 300ms задержки (debounce)
2. WHEN запрос содержит минимум 2 символа THEN система SHALL вернуть до 10 результатов из публикаций, категорий и тегов
3. WHEN результаты получены THEN система SHALL отобразить выпадающий список с названием, типом и превью
4. WHEN пользователь кликает на результат THEN система SHALL перенаправить на соответствующую страницу
5. WHEN пользователь нажимает Enter THEN система SHALL перенаправить на страницу полного поиска `/search?q={query}`
6. IF результатов нет THEN система SHALL отобразить сообщение "Ничего не найдено"

### Требование 8: Управление SEO в админке

**User Story:** Как администратор, я хочу управлять настройками SEO сайта, чтобы улучшить видимость в поисковых системах и привлечь больше посетителей.

#### Критерии приёмки

##### 8.1 Глобальные мета-теги
1. WHEN администратор переходит на `/admin/seo` THEN система SHALL отобразить форму глобальных SEO настроек
2. WHEN администратор редактирует глобальные настройки THEN система SHALL позволить задать: site_title, site_description, site_keywords, default_og_image
3. WHEN страница не имеет собственных мета-тегов THEN система SHALL использовать глобальные значения по умолчанию

##### 8.2 SEO для публикаций и категорий
4. WHEN администратор редактирует публикацию THEN система SHALL отобразить SEO-секцию с полями: meta_title, meta_description, og_title, og_description, og_image
5. WHEN администратор редактирует категорию THEN система SHALL отобразить SEO-секцию с полями: meta_title, meta_description
6. WHEN meta_title пустой THEN система SHALL автоматически использовать заголовок публикации/категории
7. WHEN meta_description пустой THEN система SHALL автоматически генерировать из первых 160 символов контента

##### 8.3 Управление ЧПУ (Slug)
8. WHEN администратор создаёт публикацию/категорию THEN система SHALL автоматически генерировать slug из заголовка (транслитерация)
9. WHEN администратор редактирует slug THEN система SHALL валидировать уникальность и допустимые символы (a-z, 0-9, дефис)
10. WHEN slug изменяется для существующей публикации THEN система SHALL предложить создать 301 редирект со старого URL
11. WHEN пользователь переходит по старому URL с редиректом THEN система SHALL выполнить 301 редирект на новый URL

##### 8.4 Генерация Sitemap
12. WHEN администратор переходит на `/admin/seo/sitemap` THEN система SHALL отобразить настройки генерации sitemap
13. WHEN администратор нажимает "Сгенерировать sitemap" THEN система SHALL создать XML sitemap со всеми публикациями, категориями и статическими страницами
14. WHEN sitemap генерируется THEN система SHALL включить: loc, lastmod, changefreq, priority для каждого URL
15. WHEN посетитель запрашивает `/sitemap.xml` THEN система SHALL вернуть актуальный XML sitemap
16. WHEN администратор настраивает sitemap THEN система SHALL позволить исключить определённые страницы/категории

##### 8.5 Редактирование robots.txt
17. WHEN администратор переходит на `/admin/seo/robots` THEN система SHALL отобразить текстовый редактор для robots.txt
18. WHEN администратор сохраняет robots.txt THEN система SHALL записать содержимое в файл `/web/robots.txt`
19. WHEN robots.txt не существует THEN система SHALL создать файл с базовыми правилами (User-agent: *, Allow: /, Sitemap: {url}/sitemap.xml)
20. WHEN администратор вводит некорректный синтаксис THEN система SHALL отобразить предупреждение (но позволить сохранить)

##### 8.6 Редиректы
21. WHEN администратор переходит на `/admin/seo/redirects` THEN система SHALL отобразить список всех 301 редиректов
22. WHEN администратор создаёт редирект THEN система SHALL запросить: source_url, target_url, тип (301/302)
23. WHEN посетитель запрашивает URL с активным редиректом THEN система SHALL выполнить перенаправление с указанным кодом
24. IF source_url уже существует THEN система SHALL отобразить ошибку валидации

##### 8.7 Структурированные данные (Schema.org)
25. WHEN страница публикации отображается THEN система SHALL включить JSON-LD разметку Article с полями: headline, author, datePublished, dateModified, image
26. WHEN страница категории отображается THEN система SHALL включить JSON-LD разметку CollectionPage
27. WHEN главная страница отображается THEN система SHALL включить JSON-LD разметку WebSite с SearchAction

##### 8.8 Canonical URL
28. WHEN страница публикации отображается THEN система SHALL включить тег `<link rel="canonical">` с каноническим URL
29. WHEN администратор редактирует публикацию THEN система SHALL позволить указать кастомный canonical URL
30. WHEN canonical URL не указан THEN система SHALL автоматически использовать текущий URL страницы
31. WHEN страница имеет пагинацию THEN система SHALL указать canonical на первую страницу или использовать rel="prev/next"

##### 8.9 Интеграция с вебмастер-сервисами
32. WHEN администратор переходит на `/admin/seo/webmaster` THEN система SHALL отобразить форму для кодов верификации
33. WHEN администратор вводит код Google Search Console THEN система SHALL добавить мета-тег `google-site-verification` в head
34. WHEN администратор вводит код Yandex Webmaster THEN система SHALL добавить мета-тег `yandex-verification` в head
35. WHEN администратор вводит код Bing Webmaster THEN система SHALL добавить мета-тег `msvalidate.01` в head
36. WHEN коды верификации сохранены THEN система SHALL отображать их на всех страницах сайта

##### 8.10 SEO-анализ контента
37. WHEN администратор редактирует публикацию THEN система SHALL отобразить панель SEO-анализа с рекомендациями
38. WHEN заголовок публикации длиннее 60 символов THEN система SHALL показать предупреждение "Заголовок слишком длинный для поисковой выдачи"
39. WHEN meta_description длиннее 160 символов THEN система SHALL показать предупреждение "Описание будет обрезано в поисковой выдачи"
40. WHEN meta_description короче 120 символов THEN система SHALL показать рекомендацию "Описание слишком короткое"
41. WHEN публикация не содержит изображений THEN система SHALL показать рекомендацию "Добавьте изображение для лучшего отображения в соцсетях"
42. WHEN ключевое слово не найдено в заголовке THEN система SHALL показать рекомендацию "Добавьте ключевое слово в заголовок"
43. WHEN контент публикации короче 300 слов THEN система SHALL показать предупреждение "Контент слишком короткий для хорошего ранжирования"
44. WHEN SEO-анализ завершён THEN система SHALL отобразить общую оценку SEO (хорошо/средне/плохо) с цветовой индикацией
